{% extends 'base.html' %}
{% load static %}

{% block title%}
Sailam QR Code Scanner
{% endblock title%}

{%block header_files%}
<script src="{% static 'js/instascan.min.js'%}"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<style>
  table.display {
    margin: 0 auto;
    width: 100%;
    clear: both;
    border-collapse: collapse;
    table-layout: fixed;          
    word-wrap:break-word;        
  }
</style>
<style>
  .editable {
    cursor: pointer;
  }

  .editable input {
    width: 100%;
    box-sizing: border-box;
  }

  .total {
    font-weight: bold;
  }
</style>
{%endblock header_files%}

{%block content%}
<div id="csrf">
{% csrf_token %}
</div>
<div class="card" style="width: 18rem">
  <button class="btn btn-primary" type="button" id="toggleButton" name="toggleButton">Start Camera</button>
  <video id="preview"></video></div>
</div>

<div class="card" style="margin-top:15px">
  <div class="card-body">
    <h5 class="card-title">Scan QR Code</h5>
    <div class="input-group">
      <input class="form-control" type="text" placeholder="Enter GIA or URL" id="gianum" name="gianum">
      <button class="btn btn-primary" type="button" id="getreport" name="getreport">Get Report</button>
    </div>
  </div>
</div>

  <div class="card" style="margin-top:15px">
    <div class="card-body">
      <ul class="nav nav-tabs" id="myTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab" aria-controls="tab1" aria-selected="false">Memo</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab" aria-controls="tab2" aria-selected="false">Invoice</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab3-tab" data-toggle="tab" href="#tab3" role="tab" aria-controls="tab3" aria-selected="false">Hide</a>
        </li>
       <li class="nav-item">
          <a class="nav-link" id="tab4-tab" data-toggle="tab" href="#tab4" role="tab" aria-controls="tab4" aria-selected="false">Add Tally</a>
        </li> 
        <li class="nav-item">
          <a class="nav-link" id="tab5-tab" data-toggle="tab" href="#tab5" role="tab" aria-controls="tab5" aria-selected="false">Remove Tally</a>
        </li> 
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
          <table id="memo_table" class="display table table-striped table-hover" cellspacing="0" width="100%">
            <thead class="thead-dark">
            <tr>
            <th>Stock Id</th>
            <th>Description</th>
            <th>Weight</th>
            <th>Remark</th>
            <th>Rate</th>
            <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
            </table>
            <button class="btn btn-info" id="submitmemo" >Generate Memo</button>
        </div>

        <div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
          <table id="inventTable" class="table table-striped table-hover" width="100%">
            <thead class="thead-dark">
              <tr>
                <th>NO.</th>
                <th>DESCRIPTION</th>
                <th>PCS.</th>
                <th>CTS</th>
                <th>CFR US $</th>
                <th>TOTAL US$</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th></th>
                <th>Total:</th>
                <th id="total-pcs"></th>
                <th id="total-cts"></th>
                <th id="total-cfr"></th>
                <th id="total-us"></th>
            </tr>
          </tfoot>
          </table>
          <button class="btn btn-info" id="submitinvoice" >Generate Invoice</button>
        </div>
       
        <div class="tab-pane fade" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
          <table id="hide_table" class="display table table-striped table-hover" cellspacing="0" width="100%">
            <thead class="thead-dark">
            <tr>
            <th>Stock Id</th>
            <th>Description</th>
            <th>Weight</th>
            <th>Remark</th>
            <th>Rate</th>
            <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
            </table>
            <button class="btn btn-info" id="submithide" >Hide Data</button>
        </div>

        <div class="tab-pane fade" id="tab4" role="tabpanel" aria-labelledby="tab4-tab">
          <table id="tally_table" class="table table-striped table-hover" width="100%">
            <thead class="thead-dark">
              <tr>
            <th>Stock Id</th>
            <th>Description</th>
            <th>Weight</th>
            <th>Remark</th>
            <th>Rate</th>
            <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
          </tfoot>
          </table>
          <button class="btn btn-info" id="submittally" >Tally Diamonds</button>
        </div> 

        <div class="tab-pane fade" id="tab5" role="tabpanel" aria-labelledby="tab5-tab">
          <table id="removetally_table" class="table table-striped table-hover" width="100%">
            <thead class="thead-dark">
              <tr>
            <th>Stock Id</th>
            <th>Description</th>
            <th>Weight</th>
            <th>Remark</th>
            <th>Rate</th>
            <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
          </tfoot>
          </table>
          <button class="btn btn-info" id="removetally" >Remove Tally</button>
        </div> 

      </div>
    </div>
  </div>

  <div class="modal fade" id="memoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Edit Memo Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="m1close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label for="desc-input">Description</label>
          <input class="form-control  mb-3" type="text" id="desc-input" placeholder="Description"/>
          <label for="weight-input">Weight</label>
          <input class="form-control  mb-3" type="text" id="weight-input" placeholder="Weight"/>
          <label for="remark-input">Remark</label>
          <input class="form-control  mb-3" type="text" id="remark-input" placeholder="Remark"/>
          <label for="rate-input">Rate</label>
          <input class="form-control  mb-3" type="text" id="rate-input" placeholder="Rate"/>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" id="m11close">Close</button>
          <button id="save-button" class="btn btn-primary">Update</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="clientmemoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Enter Client Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label for="desc-input">Client Name</label>
          <input class="form-control  my-3" type="text" id="clientname" placeholder="Name"/>
          <label for="weight-input">Client Comapany</label>
          <input class="form-control  my-3" type="text" id="clientcompany" placeholder="Company"/>
          <label for="remark-input">Company Address</label>
          <textarea class="form-control  my-3"  id="companyaddress" placeholder="Address"></textarea>
          <div>
            <input type="checkbox" id="dohide" name="dohide" value="hide">
            <label for="dohide"> Hide</label><br>
          </div>
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="getmemo" class="btn btn-info">Get Memo</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="clientinvoiceModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Enter Client Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label for="desc-input">Client Name</label>
          <input class="form-control  my-3" type="text" id="invclientname" placeholder="Name"/>
          <label for="weight-input">Client Comapany</label>
          <input class="form-control  my-3" type="text" id="invclientcompany" placeholder="Company"/>
          <label for="remark-input">Company Address</label>
          <textarea class="form-control  my-3"  id="invcompanyaddress" placeholder="Address"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="getinvoice" class="btn btn-info">Get Invoice</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="tallyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Enter Tally Group Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label for="desc-input">Group Name</label>
          <input class="form-control  my-3" type="text" id="groupname" placeholder="Group Name"/>
          <div id="suggestion-list" class="list-group"></div>
          <div>
            <input type="checkbox" id="donew" name="donew" value="new">
            <label for="donew"> New Tally</label><br>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="tallydiam" class="btn btn-info">Tally Diamond</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    var dataTable;
    var table;
    var target;
    var pcs=0;
    var cts=0;
    var cfr=0;
    var tusd=0;
    $(document).ready(function () {
      //datatables initialize
      dataTable=$("#memo_table").DataTable({
        dom: 'lBfrtip',
      buttons: [
          {
              extend: 'pdfHtml5',
              download: 'open',
              className:'btn btn-info mt-3',
              title: 'Sailam Memo',
          },
        {
          extend: 'csvHtml5',
          download: 'open',
          className:'btn btn-info mt-3',

      },
      ]});


      table = $('#inventTable').DataTable({
      dom: 'lBfrtip',
      buttons: [
          {
              extend: 'pdfHtml5',
              download: 'open',
              className:'btn btn-info mt-3',
              title: 'Sailam Invoice',
              footer:true,
          },
        {
          extend: 'csvHtml5',
          download: 'open',
          className:'btn btn-info mt-3',
          footer:true,
      },
      ]});

      hidetable = $('#hide_table').DataTable({
        dom: 'lBfrtip',
        buttons: [
            {
                extend: 'pdfHtml5',
                download: 'open',
                className:'btn btn-info mt-3',
                title: 'Sailam Hide Data',
                footer:true,
            },
          {
            extend: 'csvHtml5',
            download: 'open',
            className:'btn btn-info mt-3',
            footer:true,
        },
        ]});


         tallytable = $('#tally_table').DataTable({
          dom: 'lBfrtip',
          buttons: [
              {
                  extend: 'pdfHtml5',
                  download: 'open',
                  className:'btn btn-info mt-3',
                  title: 'Sailam Tally Data',
                  footer:true,
              },
            {
              extend: 'csvHtml5',
              download: 'open',
              className:'btn btn-info mt-3',
              footer:true,
          },
          ]}); 

          removetallytable = $('#removetally_table').DataTable({
            dom: 'lBfrtip',
            buttons: [
                {
                    extend: 'pdfHtml5',
                    download: 'open',
                    className:'btn btn-info mt-3',
                    title: 'Sailam Received Tally Data',
                    footer:true,
                },
              {
                extend: 'csvHtml5',
                download: 'open',
                className:'btn btn-info mt-3',
                footer:true,
            },
            ]}); 

      //detect current active tab
      $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        target = $(e.target).attr("id");
      });
    });
    
    $(document).ready(function () {
      $('#getreport').click(
         function()
         {
            if(!$('#gianum').val())
            {
              alert("please write GIA Number");
              $('#gianum').css("border-color","red");
              return false;
            }  
            else{
              $('#gianum').css("border-color","black");
            }

            if(target === "tab1-tab") 
            {
                var value= $('#gianum').val().split("=")
                var request = new XMLHttpRequest();
                var url = "{% url 'memo_data' scanid=0 %}".replace('0',value[1]!=undefined?value[1]:value[0])
                request.onload = function() {
                  if ( request.readyState === 4 && request.status === 200 ) {
                    var JSONObject = JSON.parse(request.responseText);
                    updatememoTable(JSONObject);
                  } else if(request.status == 400) { console.log("Error", request.status);}
                };
                  request.open("GET", url, true);
                  request.send();
            }
            else if(target==="tab2-tab")
            {
              var value= $('#gianum').val().split("=")
                var request = new XMLHttpRequest();
                var url = "{% url 'get_invoicedata' scanid=0 %}".replace('0', value[1]!=undefined?value[1]:value[0]);
                request.onload = function() {
                  if ( request.readyState === 4 && request.status === 200 ) {
                    var JSONObject = JSON.parse(request.responseText);
                    loadData(JSONObject);
                  } else if(request.status == 400) { console.log("Error", request.status);}
                };
                  request.open("GET", url, true);
                  request.send();
            } 
            else if(target==="tab3-tab")
            {
              var value= $('#gianum').val().split("=")
                var request = new XMLHttpRequest();
                var url = "{% url 'get_hidedata' scanid=0 %}".replace('0', value[1]!=undefined?value[1]:value[0]);
                request.onload = function() {
                  if ( request.readyState === 4 && request.status === 200 ) {
                    var JSONObject = JSON.parse(request.responseText);
                    loadhideData(JSONObject);
                  } else if(request.status == 400) { console.log("Error", request.status);}
                };
                  request.open("GET", url, true);
                  request.send();
            }
            else if(target==="tab4-tab")
            {
              var value= $('#gianum').val().split("=")
                var request = new XMLHttpRequest();
                var url = "{% url 'get_tallydata' tally_id=0 tally_type=1 %}".replace('1',"insert").replace('0', value[1]!=undefined?value[1]:value[0]);
                request.onload = function() {
                  if ( request.readyState === 4 && request.status === 200 ) {
                    var JSONObject = JSON.parse(request.responseText);
                    loadTallyData(JSONObject);
                  } else if(request.status == 400) { console.log("Error", request.status);}
                };
                  request.open("GET", url, true);
                  request.send();
            } 
            else if(target==="tab5-tab")
            {
              var value= $('#gianum').val().split("=")
                var request = new XMLHttpRequest();
                var url = "{% url 'get_tallydata' tally_id=0 tally_type=1 %}".replace('1',"remove").replace('0', value[1]!=undefined?value[1]:value[0]);
                request.onload = function() {
                  if ( request.readyState === 4 && request.status === 200 ) {
                    var JSONObject = JSON.parse(request.responseText);
                    loadRemoveTallyData(JSONObject);
                  } else if(request.status == 400) { console.log("Error", request.status);}
                };
                  request.open("GET", url, true);
                  request.send();
            }
            else{
              alert('Please Select One Tab From Below');
            }

         }
      );
    });
  </script>

   <script>
    //script for tally remove
    removetally
    function loadRemoveTallyData(newData) {
      if(newData.stk_id != "null")
        {
              var rowData = [];
              rowData.push(newData.stk_id);
              rowData.push(newData.desc);
              rowData.push(newData.weight);
              rowData.push(newData.remark);
              rowData.push(newData.price);
              rowData.push('<button type="button"class="btn btn-danger btn-xs dt-delete" id="1"><span class="fe fe-trash-2 fe-16" aria-hidden="true"></span></button>');
              if(!isRowExists(table,rowData) && !isRowExists(dataTable,rowData) && !isRowExists(hidetable,rowData) && !isRowExists(tallytable,rowData) && !isRowExists(removetallytable,rowData))
              {
                removetallytable.row.add(rowData).draw();

                  $('.dt-delete').off('click');
                  $('.dt-delete').each(function () {
                    $(this).on('click', function(evt){
                    $this = $(this);
                    var dtRow = $this.parents('tr');
                   if(confirm("Are you sure to delete this row?")){
                    removetallytable.row(dtRow[0].rowIndex-1).remove().draw( false );
                   }
              });
            });
              }
              else{
                alert('Data Already Exist in This or Other Tab');
              }
              
        }
      else{
        alert("Data For Given GIA Is Not Available Or Tally Is Not Done for this");
      }
    }

    $(document).on("click","#removetally",function(){
      if(removetallytable.data().count()>0)
       {
        var data= removetallytable.rows().data();
        var res={};
        res['stk_id']=[];
        for(var i=0;i<data.length;i++)
        {
          res['stk_id'].push(data[i][0]);
        }
        var resp=JSON.stringify(res);
        sendremovetallydata(resp);
        removetallytable.clear().draw(); 
       }
       else{
        alert('Select At least Single Entry for Remove Tally');
       }
      
  });

  function sendremovetallydata(data){
    $.ajax({
      type: "POST",
      headers: {'X-CSRFToken': document.getElementById('csrf').querySelector('input').value},
      url: "{% url 'settally' tally_type=0%}".replace('0', "remove"),
      data: data,
      contentType: 'application/json',
      success: function(response){
        console.log("Tally Removed Successfull");
      },
    });
  }
   </script>

   <script>
    //script for tally
    $(document).ready(function () {
      var groupdata =JSON.parse("{{groupdata|escapejs}}");
      var data=[];
      for(var x in groupdata){
        data.push(groupdata[x].group);
    }
      $('#groupname').on('input', function () {
          var query = $(this).val();
          showSuggestions(query);
      });
  
      function showSuggestions(query) {
          var suggestionList = $('#suggestion-list');
          suggestionList.empty();
  
          if (query.length === 0) {
              suggestionList.hide();
              return;
          }
  
          var matchingSuggestions = data.filter(function (suggestion) {
              return suggestion.toLowerCase().includes(query.toLowerCase());
          });
  
          matchingSuggestions.forEach(function (suggestion) {
              var listItem = $('<a>').text(suggestion).addClass('list-group-item list-group-item-action');
              suggestionList.append(listItem);
          });
  
          suggestionList.show();
      }
  
      $('#suggestion-list').on('click', '.list-group-item', function () {
          var selectedSuggestion = $(this).text();
          $('#groupname').val(selectedSuggestion);
          $('#suggestion-list').hide();
      });
  
      $(document).on('click', function (event) {
          if (!$(event.target).closest('#groupname').length) {
              $('#suggestion-list').hide();
          }
      });
    });

    var tallymodal = $('#tallyModal');
    function loadTallyData(newData) {
      if(newData.stk_id != "null")
        {
              var rowData = [];
              rowData.push(newData.stk_id);
              rowData.push(newData.desc);
              rowData.push(newData.weight);
              rowData.push(newData.remark);
              rowData.push(newData.price);
              rowData.push('<button type="button"class="btn btn-danger btn-xs dt-delete" id="1"><span class="fe fe-trash-2 fe-16" aria-hidden="true"></span></button>');
              if(!isRowExists(table,rowData) && !isRowExists(dataTable,rowData) && !isRowExists(hidetable,rowData) && !isRowExists(tallytable,rowData)&& !isRowExists(removetallytable,rowData))
              {
                  tallytable.row.add(rowData).draw();

                  $('.dt-delete').off('click');
                  $('.dt-delete').each(function () {
                    $(this).on('click', function(evt){
                    $this = $(this);
                    var dtRow = $this.parents('tr');
                   if(confirm("Are you sure to delete this row?")){
                      tallytable.row(dtRow[0].rowIndex-1).remove().draw( false );
                   }
              });
            });
              }
              else{
                alert('Data Already Exist in This or Other Tab');
              }
              
        }
      else{
        alert("Data For Given GIA Is Not Available Or Tally Is Already Prepared for this");
      }
    }

    $(document).on('click','#submittally',function(){
       if(tallytable.data().count()>0)
       {
        tallymodal.modal({ show: true });
       }
       else{
        alert('Select At least Single Entry for Add Tally')
       }
    });

    $(document).on("click","#tallydiam",function(){
      var data= tallytable.rows().data();
      var res={};
      var gp=$('#groupname').val();
      var donew=$('#donew').is(':checked');
      res['group']=gp;
      res['new']=donew;
      res['stk_id']=[];
      for(var i=0;i<data.length;i++)
      {
        res['stk_id'].push(data[i][0]);
      }
      var resp=JSON.stringify(res);
      sendtallydata(resp);
      tallymodal.modal('hide');
      tallytable.clear().draw(); 
  });

  function sendtallydata(data){
    $.ajax({
      type: "POST",
      headers: {'X-CSRFToken': document.getElementById('csrf').querySelector('input').value},
      url: "{% url 'settally' tally_type=0%}".replace('0', "insert"),
      data: data,
      contentType: 'application/json',
      success: function(response){
        console.log("Tally Successfull");
      },
    });
  }
  </script> 

  <script>
   //script for Hide

   function loadhideData(data)
   {
    if(data.stk_id != "null")
    {
          var rowData = [];
          rowData.push(data.stk_id);
          rowData.push(data.desc);
          rowData.push(data.weight);
          rowData.push(data.remark);
          rowData.push(data.price);
          rowData.push('<button type="button" class="btn btn-danger btn-xs dt-delete"><span class="fe fe-trash-2 fe-16" aria-hidden="true"></span></button>');
          if(!isRowExists(hidetable,rowData) && !isRowExists(dataTable,rowData) && !isRowExists(table,rowData)&& !isRowExists(tallytable,rowData) && !isRowExists(removetallytable,rowData))
          {
              hidetable.row.add(rowData).draw();

            $('.dt-delete').off('click');
            $('.dt-delete').each(function () {
              $(this).on('click', function(evt){
                $this = $(this);
                var dtRow = $this.parents('tr');
                if(confirm("Are you sure to delete this row?")){
                  hidetable.row(dtRow[0].rowIndex-1).remove().draw( false );
                }
              });
            });
          }
          else{
            alert('Data Already Exist in This or Other Tab');
          }
          
    }
  else{
    alert("Data For Given GIA Is Not Available Or Diamond Is Already Sold");
  }
}

$(document).on("click","#submithide",function(){
    var data= hidetable.rows().data();
    var res={};
    res['stk_id']=[];
    for(var i=0;i<data.length;i++)
    {
      res['stk_id'].push(data[i][0]);
    }
    var resp=JSON.stringify(res);
    sendhidedata(resp);
    hidetable.clear().draw();
});

function sendhidedata(data){
  $.ajax({
    type: "POST",
    headers: {'X-CSRFToken': document.getElementById('csrf').querySelector('input').value},
    url: "{% url 'sethide' %}",
    data: data,
    contentType: 'application/json',
    success: function(response){
      console.log("Data Hide Successfull");
    },
  });
}

</script>

  <script>
  //script for invoice

  $("#inventTable").on("click","tbody td:not(:nth-child(1), :last-child, :nth-last-child(2))",function() {
    var cell = $(this);
    var originalContent = cell.text();
    var newContent;
    var columnIndex=cell.index();
    var row = cell.closest("tr");
    var rowData = [];
    row.find("td").each(function() {
      var cellData = $(this).text();
      rowData.push(cellData);
    });

    var input = $("<input type='text'>");
    input.val(originalContent);
    
    // Replace the cell's content with the input field
    cell.html(input);
    
    // Focus on the input field and select its contents
    input.focus();
    
    // Update the cell's content when the input field loses focus
    input.blur(function() {
      newContent = $(this).val();
      cell.html(newContent);
      handelUpdate(columnIndex,row,originalContent,newContent);
    });
    
    // Update the cell's content when the Enter key is pressed
    input.keypress(function(e) {
      if (e.which === 13) {
        newContent = $(this).val();
        cell.html(newContent);
        handelUpdate(columnIndex,row,originalContent,newContent);
      }
    });
 

  function handelUpdate(index,row,oldval,newval)
  {
    
    if (index === 3 || index === 4) {
      var cts = row.find("td:nth-child(4)").text();
      var cfrUs = row.find("td:nth-child(5)").text();
      var totalUs = cts * cfrUs;
      updatetusd(row.find("td:nth-child(6)").text(),totalUs);
      row.find("td:nth-child(6)").text(totalUs.toFixed(2));
    }

    if(index === 2)
    {
       updatepcs(oldval,newval)
    }
    if(index === 3)
    {
       updatects(oldval,newval)
    }
    if(index === 4)
    {
       updatecfr(oldval,newval)
    }
  }
  
});

  function loadData(newData) {
      if(newData.NO != "null")
        {
              var rowData = [];
              rowData.push(newData.NO);
              rowData.push(newData.DESCRIPTION);
              rowData.push(newData.PCS);
              rowData.push(newData.CTS);
              rowData.push(newData.CFR_US_$);
              rowData.push(caltotal(newData.CTS,newData.CFR_US_$));
              rowData.push('<button type="button" onclick="ondelete(this)" class="btn btn-danger btn-xs bt-delete" id="1"><span class="fe fe-trash-2 fe-16" aria-hidden="true"></span></button>');
              if(!isRowExists(table,rowData) && !isRowExists(dataTable,rowData) && !isRowExists(hidetable,rowData)&& !isRowExists(tallytable,rowData) && !isRowExists(removetallytable,rowData))
              {
                  table.row.add(rowData).draw();
                  updatefooter(rowData);

              }
              else{
                alert('Data Already Exist in This or Other Tab');
              }
              
        }
      else{
        alert("Data For Given GIA Is Not Available Or Bill Is Already Prepared for this");
      }
    }
   function ondelete(e)
   {
    var cell = $(e);
    var row = cell.closest("tr").find("td");
        if(confirm("Are you sure to delete this row?")){
          delfooter(row);
          table.row(row).remove().draw( false );
        } 
  }

function updatefooter(row)
{
   pcs+=parseInt(row[2]);
   $(table.column(2).footer()).html(pcs.toFixed(2));

   cts+=parseFloat(row[3]);
   $(table.column(3).footer()).html(cts.toFixed(2));

  
   cfr+=parseFloat(row[4]);
   $(table.column(4).footer()).html(cfr.toFixed(2));

   tusd+=parseFloat(row[5]);
   $(table.column(5).footer()).html(tusd.toFixed(2));
}

 function updatetusd(oldval,newval)
 {
  console.log("usdOld: "+oldval);
  console.log("usdNew: "+newval);
   tusd-=parseFloat(oldval);
   tusd+=parseFloat(newval);
   console.log("tusd: "+tusd);
   $(table.column(5).footer()).html(tusd.toFixed(2));
 }
 function updatecfr(oldval,newval)
 {
   cfr-=parseFloat(oldval);
   cfr+=parseFloat(newval);
  $(table.column(4).footer()).html(cfr.toFixed(2));
 }
 function updatects(oldval,newval)
 {
   cts-=parseFloat(oldval);
   cts+=parseFloat(newval);
  $(table.column(3).footer()).html(cts.toFixed(2));
 }
 function updatepcs(oldval,newval)
 {
   pcs-=parseFloat(oldval);
   pcs+=parseFloat(newval);
  $(table.column(2).footer()).html(pcs.toFixed(2));
 }
 
function delfooter(row)
{
  pcs-=parseInt(row[2].textContent);
  $(table.column(2).footer()).html(pcs.toFixed(2));

  cts-=parseFloat(row[3].textContent);
  $(table.column(3).footer()).html(cts.toFixed(2));

 
  cfr-=parseFloat(row[4].textContent);
  $(table.column(4).footer()).html(cfr.toFixed(2));

  tusd-=parseFloat(row[5].textContent);
  $(table.column(5).footer()).html(tusd.toFixed(2));
}


 function caltotal(a,b)
 {
    var res=parseFloat(a)*parseFloat(b);
    return res;
 }
 
 $(document).on('click','#submitinvoice',function(){
  var modal = $('#clientinvoiceModal');
   if(table.data().count()>0)
   {
    modal.modal({ show: true });
   }
   else{
    alert('Select At least Single Entry for Invoice')
   }
});

function resetFooter()
{
  var value=0;
  pcs=0;
  cts=0;
  cfr=0;
  tusd=0;
  $(table.column(2).footer()).html(value.toFixed(2));
  $(table.column(3).footer()).html(value.toFixed(2));
  $(table.column(4).footer()).html(value.toFixed(2));
  $(table.column(5).footer()).html(value.toFixed(2));
}

$(document).on('click','#getinvoice',function(){
  var clientmodal=$('#clientinvoiceModal')
  var clientname=$('#invclientname').val();
  var clientcompany=$('#invclientcompany').val();
  var address=$('textarea#invcompanyaddress').val();
  var data= table.rows().data();
  var invoice={};
  var client={};
  client['name']=clientname;
  client['company']=clientcompany;
  client['address']=address;
  invoice['diamond']=[];
  for(var i=0;i<data.length;i++)
  {
    var diamond = {};
    var row=data[i];
    diamond['stk_no']=row[0];
    diamond['description']=row[1];
    diamond['pcs']=row[2];
    diamond['weight']=row[3];
    diamond['cfr']=row[4];
    diamond['total']=row[5];
    invoice['diamond'].push(diamond);
  }
  total={};
  total['pcs']=$(table.column(2).footer()).html();
  total['cts']=$(table.column(3).footer()).html();
  total['cfr']=$(table.column(4).footer()).html();
  total['tusd']=$(table.column(5).footer()).html();
  invoice['client']=client;
  invoice['total']=total;
  var resp=JSON.stringify(invoice);
  sendinvoicedata(resp)
  clientmodal.modal('hide');
  table.clear().draw();
  resetFooter();
});

function sendinvoicedata(data){
  $.ajax({
    type: "POST",
    headers: {'X-CSRFToken': document.getElementById('csrf').querySelector('input').value},
    url: "{% url 'setinvoice' %}",
    data: data,
    contentType: 'application/json',
    success: function(response){
      var filename=response
      console.log(filename);
      window.open("{% url 'pdf_response'  file_name=0 %}".replace('0', filename));
    },
  });
}

  </script>
  
  <script>
    //script for memo
    function isRowExists(dataTable, rowData) {
      var rows = dataTable.rows().data().toArray();
      for (var i = 0; i < rows.length; i++) {
         if (rows[i][0] === rowData[0]) {
            return true;
         }
      }
      return false;
   }
   //functions related to memo
     function updatememoTable(data)
     {
        if(data.stk_id != "null")
        {
              var rowData = [];
              rowData.push(data.stk_id);
              rowData.push(data.desc);
              rowData.push(data.weight);
              rowData.push(data.remark);
              rowData.push(data.price);
              rowData.push('<button type="button" class="btn btn-primary btn-xs dt-edit mr-3" id="edit-button" ><span class="fe fe-edit fe-16" aria-hidden="true"></span></button><button type="button" class="btn btn-danger btn-xs dt-delete"><span class="fe fe-trash-2 fe-16" aria-hidden="true"></span></button>');
              if(!isRowExists(dataTable,rowData) && !isRowExists(table,rowData) && !isRowExists(hidetable,rowData)&& !isRowExists(tallytable,rowData) && !isRowExists(removetallytable,rowData))
              {
                  dataTable.row.add(rowData).draw();

                $('.dt-delete').off('click');
                $('.dt-delete').each(function () {
                  $(this).on('click', function(evt){
                    $this = $(this);
                    var dtRow = $this.parents('tr');
                    if(confirm("Are you sure to delete this row?")){
                      dataTable.row(dtRow[0].rowIndex-1).remove().draw( false );
                    }
                  });
                });
              }
              else{
                alert('Data Already Exist in This or Other Tab');
              }
              
        }
      else{
        alert("Data For Given GIA Is Not Available Or Memo Is Already Prepared for this");
      }
    }
     //handles updation of memo
    $(document).ready(function() {
      var modal = $('#memoModal');
      var closeButton = $('.close');
      var saveButton = $('#save-button');
      var tbrow;

      $(document).on('click','#edit-button',function() {
        var row = $(this).closest('tr');
        tbrow=row;
        var desc = row.find('td:eq(1)').text();
        console.log(desc)
        var weight = row.find('td:eq(2)').text();
        var remark = row.find('td:eq(3)').text();
        var rate = row.find('td:eq(4)').text();
        $('#edit-button').modal('show');
        modal.modal({ show: true });
        $('#desc-input').val(desc);
        $('#weight-input').val(weight);
        $('#remark-input').val(remark);
        $('#rate-input').val(rate);
      });
    
      $(document).on('click','#save-button',function() {
        var desc = $('#desc-input').val();
        var weight = $('#weight-input').val();
        var remark = $('#remark-input').val();
        var rate = $('#rate-input').val();
        console.log(rate);
        tbrow.find('td:eq(1)').text(desc);
        tbrow.find('td:eq(2)').text(weight);
        tbrow.find('td:eq(3)').text(remark);
        tbrow.find('td:eq(4)').text(rate);
        modal.modal('hide');
        $('.modal-backdrop').remove();
      });
    });

    $(document).on('click','#m11close',function() {
      $('.modal-backdrop').remove();
    });

    $(document).on('click','#m1close',function() {
      $('.modal-backdrop').remove();
    });

    $(document).on('click','#submitmemo',function(){
      var modal = $('#clientmemoModal');
       if(dataTable.data().count()>0)
       {
        modal.modal({ show: true });
       }
       else{
        alert('Select At least Single Entry for Memo')
       }
    });

    $(document).on('click','#getmemo',function(){
      var clientmodal=$('#clientmemoModal')
      var clientname=$('#clientname').val();
      var clientcompany=$('#clientcompany').val();
      var address=$('textarea#companyaddress').val();
      var dohide=$('#dohide').is(':checked');
      var data= dataTable.rows().data();
      var memo={};
      var client={};
      client['name']=clientname;
      client['company']=clientcompany;
      client['address']=address;
      client['dohide']=dohide;
      memo['diamond']=[];
      for(var i=0;i<data.length;i++)
      {
        var diamond = {};
        var row=data[i];
        diamond['stk_no']=row[0];
        diamond['description']=row[1];
        diamond['weight']=row[2];
        diamond['remark']=row[3];
        diamond['rate']=row[4];
        memo['diamond'].push(diamond);
      }
      memo['client']=client;
      var resp=JSON.stringify(memo);
      sendmemodata(resp);
      clientmodal.modal('hide');
      dataTable.clear().draw();
    });
   
    function sendmemodata(data){
      $.ajax({
        type: "POST",
        headers: {'X-CSRFToken': document.getElementById('csrf').querySelector('input').value},
        url: "{% url 'setmemo' %}",
        data: data,
        contentType: 'application/json',
        success: function(response){
          var filename=response
          window.open("{% url 'pdf_response'  file_name=0 %}".replace('0', filename));
        },
      });
    }
  </script>
  
  <script>
    var scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
    var isCameraOn = false;
    scanner.addListener('scan', function (content) {
      document.getElementById("gianum").value=content;
   });

    document.getElementById('toggleButton').addEventListener('click', function() {
        if (!isCameraOn) {
            startCamera();
        } else {
            stopCamera();
        }
    });

    function startCamera() {
     Instascan.Camera.getCameras().then(function (cameras) {
       if (cameras.length > 0) {
         scanner.start(cameras[1]);
       }
       else if(cameras.length > 1){
        scanner.start(cameras[1]);
       } else {
         console.error('No cameras found.');
       }
        isCameraOn = true;
        document.getElementById('toggleButton').textContent = 'Stop Camera';
        }).catch(function(e) {
            console.error(e);
        });
    }

    function stopCamera() {
      Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) {
        scanner.stop(cameras[1]);
      }
      else if(cameras.length > 1){
       scanner.stop(cameras[1]);
      }
    });
        isCameraOn = false;
        document.getElementById('toggleButton').textContent = 'Start Camera';
    }
  </script>
{%endblock content%}